{% extends "admin/base.html" %}

{% block title %}User: {{ user.nickname or user.id }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>User: {{ user.nickname or 'ID ' ~ user.id }}</h1>
    <a href="/admin/users" class="btn btn-secondary">Back to Users</a>
</div>

<div class="detail-grid">
    <div class="detail-card">
        <h2>Edit User</h2>
        <form method="post" action="/admin/users/{{ user.id }}">
            <div class="form-group">
                <label for="nickname">Nickname</label>
                <input type="text" id="nickname" name="nickname" value="{{ user.nickname or '' }}">
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="{{ user.email or '' }}">
            </div>

            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="is_active" value="true" {% if user.is_active %}checked{% endif %}>
                    Active
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="is_admin" value="true" {% if user.is_admin %}checked{% endif %}>
                    Admin
                </label>
            </div>

            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="can_post" value="true" {% if user.can_post %}checked{% endif %}>
                    Can Post (Basel Access)
                </label>
            </div>

            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>

    <div class="detail-card">
        <h2>User Info</h2>
        <dl class="info-list">
            <dt>ID</dt>
            <dd>{{ user.id }}</dd>

            <dt>Apple User ID</dt>
            <dd class="truncate">{{ user.apple_user_id }}</dd>

            <dt>First Name</dt>
            <dd>{{ user.first_name or '-' }}</dd>

            <dt>Last Name</dt>
            <dd>{{ user.last_name or '-' }}</dd>

            <dt>Phone</dt>
            <dd>{{ user.phone or '-' }}</dd>

            <dt>Instagram</dt>
            <dd>{{ user.instagram_handle or '-' }}</dd>

            <dt>LinkedIn</dt>
            <dd>{{ user.linkedin_handle or '-' }}</dd>

            <dt>Followers</dt>
            <dd>{{ follower_count }}</dd>

            <dt>Following</dt>
            <dd>{{ following_count }}</dd>

            <dt>Created</dt>
            <dd>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') if user.created_at else '-' }}</dd>

            <dt>Last Location</dt>
            <dd>
                {% if user.last_location_lat and user.last_location_lon %}
                {{ "%.4f"|format(user.last_location_lat) }}, {{ "%.4f"|format(user.last_location_lon) }}
                {% else %}
                -
                {% endif %}
            </dd>
        </dl>
    </div>
</div>

<div class="detail-section">
    <h2>Recent Check-ins ({{ user.check_ins|length }})</h2>
    {% if user.check_ins %}
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Location</th>
                <th>Active</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for checkin in user.check_ins[:10] %}
            <tr>
                <td>{{ checkin.id }}</td>
                <td>{{ checkin.location_name or 'Unknown' }}</td>
                <td>
                    {% if checkin.is_active %}
                    <span class="badge badge-success">Active</span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>{{ checkin.created_at.strftime('%Y-%m-%d %H:%M') if checkin.created_at else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No check-ins found</p>
    {% endif %}
</div>

<div class="detail-section">
    <h2>Created Bounces ({{ user.bounces_created|length }})</h2>
    {% if user.bounces_created %}
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Venue</th>
                <th>Status</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for bounce in user.bounces_created[:10] %}
            <tr>
                <td>{{ bounce.id }}</td>
                <td>{{ bounce.venue_name }}</td>
                <td>
                    <span class="badge {% if bounce.status == 'active' %}badge-success{% else %}badge-secondary{% endif %}">
                        {{ bounce.status }}
                    </span>
                </td>
                <td>{{ bounce.created_at.strftime('%Y-%m-%d %H:%M') if bounce.created_at else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No bounces created</p>
    {% endif %}
</div>

<div class="danger-zone">
    <h2>Danger Zone</h2>
    <form method="post" action="/admin/users/{{ user.id }}/delete" onsubmit="return confirm('Are you sure you want to delete this user? This cannot be undone.')">
        <button type="submit" class="btn btn-danger">Delete User</button>
    </form>
</div>
{% endblock %}
